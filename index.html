<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë„ì¿„ ê°€ì¡±ì—¬í–‰ 2026</title>
    <style>
        :root { --main: #ff4757; --bg: #f8f9fa; --card: #ffffff; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding-bottom: 100px; color: #333; }
        .header { background: var(--main); color: white; padding: 15px; text-align: center; position: sticky; top: 0; z-index: 100; font-weight: bold; font-size: 1.2rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .card { background: var(--card); margin: 15px; padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); display: none; }
        .card.active { display: block; }
        h2 { font-size: 1.3rem; color: var(--main); margin-top: 0; border-bottom: 2px solid #fff0f1; padding-bottom: 8px; }
        .info-item { font-size: 0.9rem; margin-bottom: 8px; padding-left: 12px; border-left: 3px solid #ddd; }
        
        /* ì‚¬ì§„ ë° ì‚­ì œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .photo-container { position: relative; display: inline-block; margin: 5px; }
        .photo-item { width: 100px; height: 100px; object-fit: cover; border-radius: 10px; border: 1px solid #eee; }
        .del-btn { 
            position: absolute; top: -5px; right: -5px; background: rgba(0,0,0,0.6); color: white; 
            border: none; border-radius: 50%; width: 22px; height: 22px; font-size: 12px; cursor: pointer;
        }

        textarea { width: 100%; height: 80px; border: 1px solid #eee; border-radius: 10px; padding: 12px; margin-top: 20px; box-sizing: border-box; font-family: inherit; background: #fffdf0; }
        .upload-btn { display: inline-block; padding: 8px 15px; background: #eee; border-radius: 8px; font-size: 0.85rem; cursor: pointer; margin-top: 10px; border: 1px solid #ddd; }
        
        .nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; border-top: 1px solid #eee; height: 75px; z-index: 100; }
        .nav-item { flex: 1; text-align: center; padding: 12px 0; color: #999; cursor: pointer; font-size: 0.8rem; border-right: 1px solid #f9f9f9; }
        .nav-item.active { color: var(--main); font-weight: bold; background: #fffafa; }
    </style>
</head>
<body>

<div class="header">ë„ì¿„ ê°€ì¡±ì—¬í–‰ ğŸ‡¯ğŸ‡µ</div>

<div id="day1" class="card active">
    <h2>DAY 1: ê³µí•­ & ë„ì¿„íƒ€ì›Œ</h2>
    <p>ğŸ“… 1ì›” 16ì¼ (ëª©)</p>
    <div class="info-item">âœˆï¸ 15:00 ë‚˜ë¦¬íƒ€ ë„ì°©</div>
    <div class="info-item">ğŸ“ ìˆ™ì†Œ: ì•„ì‚¬ì¿ ì‚¬ ë·° í˜¸í…”</div>
    <div id="photos-day1"></div>
    <label class="upload-btn">ğŸ“· ì‚¬ì§„ ì˜¬ë¦¬ê¸° <input type="file" hidden onchange="uploadPhoto('day1', this)"></label>
    <textarea id="memo-day1" onblur="saveMemo('day1')" placeholder="ë©”ëª¨ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”!"></textarea>
</div>
<div class="nav">
    <div class="nav-item active" onclick="go(1)">16(ëª©)<br>1ì¼ì°¨</div>
    <div class="nav-item" onclick="go(2)">17(ê¸ˆ)</div>
    <div class="nav-item" onclick="go(3)">18(í† )</div>
    <div class="nav-item" onclick="go(4)">19(ì¼)</div>
    <div class="nav-item" onclick="go(5)">20(ì›”)</div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import { getFirestore, doc, onSnapshot, setDoc, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-storage.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBweeHd4dCsd82Q2pDxPnP9IU6vjdi-S5M",
        authDomain: "tokyo-trip-2026-family.firebaseapp.com",
        projectId: "tokyo-trip-2026-family",
        storageBucket: "tokyo-trip-2026-family.firebasestorage.app",
        messagingSenderId: "669648921196",
        appId: "1:669648921196:web:79df32780bea9a4e6dee49"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // ì‚¬ì§„ ì—…ë¡œë“œ ê¸°ëŠ¥
    window.uploadPhoto = async (day, input) => {
        if (!input.files[0]) return;
        const file = input.files[0];
        const fileName = `${Date.now()}_${file.name}`;
        const storageRef = ref(storage, `photos/${day}/${fileName}`);
        
        const snapshot = await uploadBytes(storageRef, file);
        const url = await getDownloadURL(snapshot.ref);
        
        await setDoc(doc(db, "travel", day), { 
            photos: arrayUnion({ url, name: fileName }) 
        }, { merge: true });
        alert("ì‚¬ì§„ì´ ì˜¬ë¼ê°”ìŠµë‹ˆë‹¤!");
    };

    // ì‚¬ì§„ ì‚­ì œ ê¸°ëŠ¥ (Storageì™€ Firestore ë™ì‹œ ì‚­ì œ)
    window.deletePhoto = async (day, photoData) => {
        if (!confirm("ì´ ì‚¬ì§„ì„ ì •ë§ ì‚­ì œí• ê¹Œìš”?")) return;
        
        try {
            // 1. Storageì—ì„œ ì‚­ì œ
            const photoRef = ref(storage, `photos/${day}/${photoData.name}`);
            await deleteObject(photoRef);
            
            // 2. Firestore ë°ì´í„°ì—ì„œ ì‚­ì œ
            await updateDoc(doc(db, "travel", day), {
                photos: arrayRemove(photoData)
            });
            alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch (e) {
            console.error(e);
            alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    };

    // ë©”ëª¨ ì €ì¥
    window.saveMemo = async (day) => {
        const val = document.getElementById(`memo-${day}`).value;
        await setDoc(doc(db, "travel", day), { memo: val }, { merge: true });
    };

    // ì‹¤ì‹œê°„ ë™ê¸°í™”
    ['day1','day2','day3','day4','day5'].forEach(day => {
        onSnapshot(doc(db, "travel", day), (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                // ë©”ëª¨ ë™ê¸°í™”
                const memoEl = document.getElementById(`memo-${day}`);
                if (memoEl) memoEl.value = data.memo || "";
                
                // ì‚¬ì§„ ë™ê¸°í™” ë° ì‚­ì œ ë²„íŠ¼ ë Œë”ë§
                const photoDiv = document.getElementById(`photos-${day}`);
                if (photoDiv) {
                    photoDiv.innerHTML = (data.photos || []).map(p => `
                        <div class="photo-container">
                            <img src="${p.url}" class="photo-item">
                            <button class="del-btn" onclick="deletePhoto('${day}', ${JSON.stringify(p).replace(/"/g, '&quot;')})">âœ•</button>
                        </div>
                    `).join('');
                }
            }
        });
    });

    window.go = (n) => {
        document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        document.getElementById('day' + n).classList.add('active');
        document.querySelectorAll('.nav-item')[n-1].classList.add('active');
        window.scrollTo(0,0);
    };
</script>
</body>
</html>
